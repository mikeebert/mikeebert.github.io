---
layout: post
title: MySQL doesn’t care about your nulls
date: '2017-06-08T08:21:34-05:00'
tags: []
tumblr_url: http://mikeebert.tumblr.com/post/161580984480/mysql-doesnt-care-about-your-nulls
---
<p>The other day my co-worker and I stumbled across an interesting find in MySQL— and by &lsquo;stumbled&rsquo; I mean spent a good 30 minutes trying to figure out why some tests weren&rsquo;t passing. Here&rsquo;s what was happening:</p>

<p>We have an endpoint that receives incoming messages and in our database we have an <code>incoming_messages</code> table with a <code>sender</code> column. However, it is possible that <code>sender</code> might be <code>null</code> if we receive a message from an unknown source.</p>

<p>So, what I wanted to test was a function that counted all of the records that didn&rsquo;t have a specific value for the <code>sender</code> column. For instance, I wanted to count all the <code>incoming_mesages</code> that didn&rsquo;t have a sender value of &ldquo;system&rdquo;, meaning they&rsquo;d been generated by our internal systems.</p>

<p>My function under test looked liked this:</p>

{% highlight java %}
public int nonSystemMessageCount() {  
      IncomingMessage.count("sender != 'system'")  
}  
{% endhighlight %}

<p>and my test looked like this:</p>

{% highlight java %}
IncomingMessage.create("body", "some message body", "sender", null)  
the(nonSystemMessageCount()).shouldEqual(1);  
{% endhighlight %}

<p>However, no matter how many times I ran the test <code>nonSystemMessageCount()</code> returned 0, and no matter which way we debugged and how deep we went down our ORM&rsquo;s call stack- it still returned 0. One of the debugging steps that finally started to narrow it down for us was trying to create a <code>messages</code> set from <code>Message.select("sender != 'system'")</code> — which also returned an empty set.</p>

<p>Fortunately, while I was down in the rabbit hole my co-worker found the <a href="https://dev.mysql.com/doc/refman/5.7/en/counting-rows.html">MySQL documentation</a> (as well as <a href="https://mariadb.com/kb/en/mariadb/count/">MariaDB docs</a>- which we use) that revealed that neither <code>count</code> nor <code>select</code> will include any record where the value is <code>null</code> if doing a comparison, equality, or non-equality check.</p>

<p>So, ultimately we considered two options:<br/>
    1) add the <code>AND IS NULL</code> check to our SQL statement<br/>
    2) just not have <code>null</code> values in the <code>sender</code> column</p>

<p>Since we control the interface to the DB (and this is a new feature with no production data yet) we decided that we&rsquo;d rather just not deal with <code>null</code>. We placed both a DB constraint and model validation on <code>IncomingMessage</code> so that sender can never be <code>null</code>. If we don&rsquo;t know who the sender is then we set it to &ldquo;unknown&rdquo;. That&rsquo;s probably the best design anyway, even if it does feel a little defensive.</p>

<p>Although I definitely understand why <code>null</code> doesn&rsquo;t actually count for anything in a binary world, sometimes <a href="https://www.youtube.com/watch?v=29MAL8pJImQ">nothing is something</a>! In this case, all of us on the team were pretty surprised to find out that records with a null value for a column didn&rsquo;t count.</p>
